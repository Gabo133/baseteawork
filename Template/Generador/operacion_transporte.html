{% extends "Partials/Generador/_Base.html" %}
{% load static %}
{% block Title %}
Inicio
{% endblock Title %}
{% block Style %}
<style>
	.autocomplete {
  /*the container must be positioned relative:*/
  position: relative;
  display: inline-block;
}
input {
  border: 1px solid transparent;
  background-color: #f1f1f1;
  padding: 10px;
  font-size: 20px;
}
input[type=text] {
  background-color: transparent;
  width: 100%;
}
input[type=submit] {
  background-color: DodgerBlue;
  color: #fff;
}
.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 0;
  right: 0;
}
.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff; 
  border-bottom: 1px solid #d4d4d4; 
}
.autocomplete-items div:hover {
  /*when hovering an item:*/
  background-color: #e9e9e9; 
}
.autocomplete-active {
  /*when navigating through the items using the arrow keys:*/
  background-color: DodgerBlue !important; 
  color: #ffffff; 
}
</style>
{% endblock Style %}
{% block Content %}

<div class="section__content section__content--p30" > 
	<div class="container-fluid">
		<div class="row">
			<div class="col-md">
				<div class="card">
					<div class="card-header" style="background-color: rgb(82,183,78) "> 
              <div  class="nav nav-tabs justify-content-center" id="nav-tab" role="tablist">
                <a class="nav-item nav-link active" id="nav-ni-To" data-toggle="tab" href="#nav-Uni-To" role="tab" aria-controls="nav-Uni-To" aria-selected="true" style="color:rgb(85,85,89);" >Descripción de Operaciones</a>
              </div>
					</div>
					<div class="card-body">
            <div class="tab-content" id="nav-tabContent">
              <div class="tab-pane fade show active" id="nav-Uni-To" role="tabpanel" aria-labelledby="nav-Uni-To-tab">
                <div class="row">
                    
                    <div class="col-md-11">
                      <table class = "table table-bordered" style="font-size: 12px;">
                          <thead>
                            <tr>
                              <th>Rut de la Empresa</th>
                              <th>Nombre de la Empresa</th>
                              <th>Toneladas Transportadas</th>
                              <th>Fuente de Informacón</th>
                            </tr>
                          </thead>
                          <tbody id="Region">
                            {% if largo == 0 %}
                            <tr id="tr-forms">
                              <td><input id="0" value="" onchange="Rut(this,'{{trans}}','{{run}}');" type="text" class="rut form-control" placeholder="Rut"></td>
                              <td>
                                <div class="autocomplete" style="">
                                  <input id="myInput" type="text" value="" name="myCountry" class="nom form-control" placeholder="Empresa">
                                </div></td>
                              
                              <td><input id="Ton" value="" type="number" class="ton form-control" placeholder="Toneladas"></td>

                                <td>
                                    <select class="form-control fuente" id="fuente">
                                      <option>Estimación</option>
                                      <option>Guía de Despacho</option>
                                      <option>Factura</option>
                                    </select>
                                </td>
                            </tr>
                              {% endif %}
                          </tbody>
                        </table>  
                    </div>
                    <div class="col-md-1" style="padding-top: 35px;">
                      <button class="btn btn-success" type="button" id="btn_region" value="">+</button>
                      <button class="btn btn-danger" type="button" id="btn_region_del" style="display: none" >-</button>
                    </div>
                </div>
                <div class="row">
                  <div class="col-md-6"   align="right">
                    <button id="enviar_info" class="btn btn-success">Enviar</button>
                  </div>
                </div>
              </div>
            </div> 
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock Content %}
{% block JavaScript %}

<script>
$(document).ready(function() {
	function suv(){
		const suv = 2;
		return suv;
	}
var transportistas = ['prueba']
{% for i in transporte %}
	transportistas.push('{{i.Nombre_Empresa}}');
{% endfor %}


// --------------------------.---------------------------------------



function getCookie(name){
  var cookieValue = null;
  if (document.cookie && document.cookie != ''){
      var cookies = document.cookie.split(';');
      for(var i = 0; i < cookies.length; i++){
          var cookie = jQuery.trim(cookies[i]);

          if(cookie.substring(0,name.length + 1) == (name + '=')){
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue
}
{% if largo == 0 %}
  var cont = 0;
{% else %}
  var cont = -1;
{% endif %}

if(cont > 0){
	cont --;
	$("#btn_region_del").show();
}
$("#btn_region").on('click', function(event) {
	cont ++;
	var clone_nombre = $('<input/>');
	var clone_rut = $('<input/>');
	var clone_ton = $('<input/>');
  var clone_fuente = $('<select/>');
  var option1 = $('<option/>');
  var option2 = $('<option/>');
  var option3 = $('<option/>');
	var auto = $('<div/>');
	auto.attr({
		'class': 'autocomplete',
	});
	clone_nombre.attr({
		'id': 'myInput'+cont,
		'class':'nom form-control',
		'placeholder':'Empresa',
	});
  clone_fuente.attr({
    'id':'fuente',
    'class':'fuente form-control',
  })
	clone_rut.attr({
		'id': cont,
		'class': 'rut form-control ',
		'placeholder':'Rut',
		'onchange':"Rut(this,'{{trans}}','{{run}}')",
	});
	
	clone_ton.attr({
		'id': 'Ton',
		'class':'ton form-control',
		'placeholder': 'Toneladas',
	});

	var tr = $('<tr/>', {
    'id'    : 'tr-form',
	});
  option1.append('Estimación');
  option2.append('Guía de Despacho');
  option3.append('Factura');

  clone_fuente.append(option1);
  clone_fuente.append(option2);
  clone_fuente.append(option3);

	var td1 = $('<td/>');
	var td2 = $('<td/>');
  var td3 = $('<td/>');
	var td4 = $('<td/>');

	auto.append(clone_nombre)
	td1.append(auto);
	td2.append(clone_rut);
  td3.append(clone_ton);
	td4.append(clone_fuente);

	tr.append(td2);
	tr.append(td1);
  tr.append(td3);
	tr.append(td4);

	$("#Region").prepend(tr);
	$("#btn_region_del").show();

});
{% for i in info %}

cont ++;
  var clone_nombre = $('<input/>');
  var clone_rut = $('<input/>');
  var clone_ton = $('<input/>');
  var clone_fuente = $('<select/>');
  var option1 = $('<option/>');
  var option2 = $('<option/>');
  var option3 = $('<option/>');
  var auto = $('<div/>');
  auto.attr({
    'class': 'autocomplete',
  });
  clone_nombre.attr({
    'id': 'myInput'+cont,
    'class':'nom form-control',
    'placeholder':'Empresa',
    'value':'{{i.Nombre}}'
  });
  clone_fuente.attr({
    'id':'fuente',
    'class':'fuente form-control',
  })

  clone_rut.attr({
    'id': cont,
    'class': 'rut form-control ',
    'placeholder':'Rut',
    'onchange':"Rut(this,'{{trans}}','{{run}}')",
    'value':'{{i.Rut}}'
  });
  
  clone_ton.attr({
    'id': 'Ton',
    'class':'ton form-control',
    'placeholder': 'Toneladas',
    'value':'{{i.Toneladas}}'
  });

  var tr = $('<tr/>', {
    'id'    : 'tr-form',
  });
  option1.append('Estimación');
  option2.append('Guía de Despacho');
  option3.append('Factura');
  clone_fuente.append(option1);
  clone_fuente.append(option2);
  clone_fuente.append(option3);
  clone_fuente.val('{{i.get_Fuente_display}}');

  var td1 = $('<td/>');
  var td2 = $('<td/>');
  var td3 = $('<td/>');
  var td4 = $('<td/>');

  auto.append(clone_nombre)
  td1.append(auto);
  td2.append(clone_rut);
  td3.append(clone_ton);
  td4.append(clone_fuente);

  tr.append(td2);
  tr.append(td1);
  tr.append(td3);
  tr.append(td4);

  $("#Region").prepend(tr);
  if(cont>1){
    
    $("#btn_region_del").show();
  }


{% endfor %}
$("#btn_region_del").on('click', function(event) {
	cont --;
	$("#tr-form").remove();
	if(cont == 0){
		$("#btn_region_del").hide();
	}
});
$("#Siguiente").on('click', function() {
    $("#nav-p-To").tab("show");
  });

$("#enviar_info").on('click', function(event) {
	var $divn = $(".nom").toArray();
	var $divr = $(".rut").toArray();
  var $divt = $(".ton").toArray();
	var $divf = $(".fuente").toArray();

	var lista_nombre = [];
	var lista_rut = [];
  var lista_ton = [];
	var lista_fuente = [];
	var i;
	for (var i = 0; i < $divn.length; i++) {
		lista_nombre.push($divn[i].value);
		lista_rut.push($divr[i].value);
    lista_ton.push(parseFloat($divt[i].value));
		lista_fuente.push($divf[i].value);
	}
	$.ajax({
          url:"{% url 'OpTransporte' %}",
          type: "POST",
          data: {
            csrfmiddlewaretoken: getCookie('csrftoken'),
            'lista_nombre':String(lista_nombre),
            'lista_rut':String(lista_rut),
            'lista_ton':String(lista_ton),
            'lista_fuente':String(lista_fuente),
          },
          success: function(data){
            alert(data.message);
          	window.location.replace("{% url 'Certificar' %}");
            }

        });

  });
});

</script>
<script src="{% static 'js/validarut.js' %}" ></script>

{% endblock JavaScript %}